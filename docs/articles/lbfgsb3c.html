<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>lbfgsb3c: Using the 2011 version of L-BFGSB • lbfgsb3c</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="lbfgsb3c: Using the 2011 version of L-BFGSB">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">lbfgsb3c</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2019.7.16</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/lbfgsb3c.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>lbfgsb3c: Using the 2011 version of L-BFGSB</h1>
                        <h4 class="author">John C Nash Telfer School of Management, University of Ottawa, <a href="mailto:nashjc@uottawa.ca">nashjc@uottawa.ca</a>
</h4>
            
            <h4 class="date">October 18, 2019</h4>
      
      
      <div class="hidden name"><code>lbfgsb3c.Rmd</code></div>

    </div>

    
    
<div id="abstract" class="section level1">
<h1 class="hasAnchor">
<a href="#abstract" class="anchor"></a>Abstract</h1>
<p>In 2011 the authors of the L-BFGSB program published a correction and update to their 1995 code. The latter is the basis of the L-BFGS-B method of the <code><a href="https://rdrr.io/r/stats/optim.html">optim()</a></code> function in base-R. The package <code>lbfgsb3</code> wrapped the updated code using a <code>.Fortran</code> call after removing a very large number of Fortran output statements. Matthew Fidler used this Fortran code and an <code>Rcpp</code> interface to produce package <code>lbfgsb3c</code> where the function <code><a href="../reference/lbfgsb3c.html">lbfgsb3c()</a></code> returns an object similar to that of base-R <code><a href="https://rdrr.io/r/stats/optim.html">optim()</a></code> and that of <code><a href="https://rdrr.io/pkg/optimx/man/optimr.html">optimx::optimr()</a></code>. Subsequently, in a fine example of the collaborations that have made <strong>R</strong> so useful, we have merged the functionality of package <code>lbfgsb3</code> into <code>lbfgsb3c</code>, as explained in this vignette. Note that this document is intended primarily to document our efforts to check the differences in variants of the code rather than be expository.</p>
<div id="provenance-of-the-r-optiml-bfgs-b-and-related-solvers" class="section level2">
<h2 class="hasAnchor">
<a href="#provenance-of-the-r-optiml-bfgs-b-and-related-solvers" class="anchor"></a>Provenance of the R optim::L-BFGS-B and related solvers</h2>
<p>The base-R code lbfgsb.c (at writing in R-3.5.2/src/appl/) is commented:</p>
<pre><code>/* l-bfgs-b.f -- translated by f2c (version 19991025).

  From ?optim:
  The code for method ‘"L-BFGS-B"’ is based on Fortran code by Zhu,
  Byrd, Lu-Chen and Nocedal obtained from Netlib (file 'opt/lbfgs_bcm.shar')

  The Fortran files contained no copyright information.

  Byrd, R. H., Lu, P., Nocedal, J. and Zhu, C.  (1995) A limited
  memory algorithm for bound constrained optimization.
  \emph{SIAM J. Scientific Computing}, \bold{16}, 1190--1208.
*/</code></pre>
<p>The paper <span class="citation">R. H. Byrd, Lu, Nocedal, and Zhu (1995a)</span> builds on <span class="citation">Lu et al. (1994)</span>. There have been a number of other workers who have followed-up on this work, but <strong>R</strong> code and packages seem to have largely stayed with codes derived from these original papers. Though the date of the paper is 1995, the ideas it embodies were around for a decade and a half at least, in particular in Nocedal80 and LiuN89. The definitive Fortran code was published as <span class="citation">Zhu et al. (1997)</span>. This is available as <code>toms/778.zip</code> on www.netlib.org. A side-by-side comparison of the main subroutines in the two downloads from Netlib unfortunately shows a lot of differences. I have not tried to determine if these affect performance or are simply cosmetic.</p>
<p>More seriously perhaps, there were some deficiencies in the code(s), and in 2011 Nocedal’s team published a Fortran code with some corrections (<span class="citation">Morales and Nocedal (2011)</span>). Since the <strong>R</strong> code predates this, I prepared package <code>lbfgsb3</code> (<span class="citation">Nash et al. (2015)</span>) to wrap the Fortran code. However, I did not discover any test cases where the <code>optim::L-BFGS-B</code> and <code>lbfgsb3</code> were different, though I confess to only running some limited tests. There are, in fact, more in this vignette.</p>
<p>In 2016, I was at a Fields Institute optimization conference in Toronto for the 70th birthday of Andy Conn. By sheer serendipity, Nocedal did not attend the conference, but sat down next to me at the conference dinner. When I asked him about the key changes, he said that the most important one was to fix the computation of the machine precision, which was not always correct in the 1995 code. Since <strong>R</strong> gets this number as <code>.Machine$double.eps</code>, the offending code is irrelevant.</p>
<p>Within <span class="citation">Morales and Nocedal (2011)</span>, there is also reported an improvement in the subspace minimization that is applied in cases of bounds constraints. Since few of the tests I have applied impose such constraints, it is reasonable that I will not have observed performance differences between the base-R <code>optim</code> code and my <code>lbfsgb3</code> package. More appropriate tests are welcome, and on my agenda.</p>
<p>Besides the ACM TOMS code, there are two related codes from the Northwestern team on NETLIB: <a href="http://netlib.org/opt/lbfgs_um.shar" class="uri">http://netlib.org/opt/lbfgs_um.shar</a> is for unconstrained minimization, while <a href="http://netlib.org/opt/lbfgs_bcm.shar" class="uri">http://netlib.org/opt/lbfgs_bcm.shar</a> handles bounds constrained problems. To these are attached references <span class="citation">Liu and Nocedal (1989)</span> and <span class="citation">R. H. Byrd, Lu, Nocedal, and Zhu (1995b)</span> respectively, most likely reflecting the effort required to implement the constraints.</p>
<p>The unconstrained code has been converted to <strong>C</strong> under the leadership of Naoaki Okazaki (see <a href="http://www.chokkan.org/software/liblbfgs/" class="uri">http://www.chokkan.org/software/liblbfgs/</a>, or the fork at <a href="https://github.com/MIRTK/LBFGS" class="uri">https://github.com/MIRTK/LBFGS</a>). This has been wrapped for <strong>R</strong> as <span class="citation">Coppola, Stewart, and Okazaki (2014)</span> as the <code>lbfgs</code> package. This can be called from <code><a href="https://rdrr.io/pkg/optimx/man/optimr.html">optimx::optimr()</a></code>.</p>
<p>Using Rcpp (see <span class="citation">Eddelbuettel and François (2011)</span>) and the Fortran code in package <code>lbfgs3</code>, Matthew Fidler developed package <code>lbfgsb3c</code> (<span class="citation">Fidler et al. (2018)</span>). As this provides a more standard call and return than <code>lbfgsb3</code> Fidler and I are unified the two packages and released them both under the same name <code>lbfgsb3c</code>.</p>
</div>
<div id="functions-in-package-lbfgsb3c" class="section level2">
<h2 class="hasAnchor">
<a href="#functions-in-package-lbfgsb3c" class="anchor"></a>Functions in package <code>lbfgsb3c</code>
</h2>
<p>There is really only one optimizer function in the package, but it may be called by four (4) names:</p>
<ul>
<li>
<code><a href="../reference/lbfgsb3c.html">lbfgsb3c()</a></code> uses Rcpp (<span class="citation">Eddelbuettel (2013)</span>, <span class="citation">Eddelbuettel and François (2011)</span>, <span class="citation">Eddelbuettel and Balamuta (2017)</span>) to streamline the call to the underlying Fortran. This is the base function used.</li>
<li>
<code><a href="../reference/lbfgsb3c.html">lbfgsb3x()</a></code> is an alias of <code><a href="../reference/lbfgsb3c.html">lbfgsb3c()</a></code>. We were using this name for a while, and have kept the alias to avoid having to edit test scripts.</li>
<li>
<code>lbfgsb3</code>, which imitates a <code>.Fortran</code> call of the compiled 2011 Fortran code. The object returned by this routine is NOT equivalent to the object returned by base-R <code><a href="https://rdrr.io/r/stats/optim.html">optim()</a></code> or by <code><a href="https://rdrr.io/pkg/optimx/man/optimr.html">optimx::optimr()</a></code>. Instead, it includes a structure <code>info</code> which contains the detailed diagnostic information of the Fortran code. For most users, this is not of interest, and I only recommend use of this function for those needing to examine how the optimization has been carried out.</li>
<li>
<code><a href="../reference/lbfgsb3c.html">lbfgsb3f()</a></code> is an alias of <code>lbfsgb3()</code>.</li>
</ul>
<p>We recommend using the <code>lbfsgb3c()</code> call for most uses.</p>
</div>
<div id="comparison-with-optiml-bfgs-b" class="section level2">
<h2 class="hasAnchor">
<a href="#comparison-with-optiml-bfgs-b" class="anchor"></a>Comparison with optim::L-BFGS-B</h2>
<p>The new Fortran package claims better performance on bounds-constrained problems. Below we present two fairly simple tests, which unfortunately do not show any advantage. We welcome examples showing differences, either better or not. Note that we use the call that returns expanded information, but we do not interpret that here. See the documentation in the source Fortran for an explanation of the data returned in object <code>info</code>.</p>
<p>As the package <code>lbfgsb3c</code> is intended to replace package <code>lbfgsb3</code>, and the more current package is used by recent <code>optimx</code> versions, we have to test for the version of <code>optimx</code>. This unfortunately gives a rather messy output from Rmarkdown.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># ref BT.RES in Nash and Walker-Smith (1987)</span>

bt.f&lt;-<span class="cf">function</span>(x){
 <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(x<span class="op">*</span>x)
}

bt.g&lt;-<span class="cf">function</span>(x){
  gg&lt;-<span class="fl">2.0</span><span class="op">*</span>x
}

bt.badsetup&lt;-<span class="cf">function</span>(n){
   x&lt;-<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="dv">0</span>,n)
   lo&lt;-<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="dv">0</span>,n)
   up&lt;-lo <span class="co"># to get arrays set</span>
   bmsk&lt;-<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="dv">1</span>,n)
   bmsk[(<span class="kw"><a href="https://rdrr.io/r/base/Round.html">trunc</a></span>(n<span class="op">/</span><span class="dv">2</span>)<span class="op">+</span><span class="dv">1</span>)]&lt;-<span class="dv">0</span>
   <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n) { 
      x[i]&lt;-<span class="fl">2.2</span><span class="op">*</span>i<span class="op">-</span>n
      lo[i]&lt;-<span class="fl">1.0</span><span class="op">*</span>(i<span class="op">-</span><span class="dv">1</span>)<span class="op">*</span>(n<span class="op">-</span><span class="dv">1</span>)<span class="op">/</span>n
      up[i]&lt;-<span class="fl">1.0</span><span class="op">*</span>i<span class="op">*</span>(n<span class="op">+</span><span class="dv">1</span>)<span class="op">/</span>n
   }
   result&lt;-<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">x=</span>x, <span class="dt">lower=</span>lo, <span class="dt">upper=</span>up, <span class="dt">bdmsk=</span>bmsk)
}

bt.setup0&lt;-<span class="cf">function</span>(n){
   x&lt;-<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="dv">0</span>,n)
   lo&lt;-<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="dv">0</span>,n)
   up&lt;-lo <span class="co"># to get arrays set</span>
   bmsk&lt;-<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="dv">1</span>,n)
   bmsk[(<span class="kw"><a href="https://rdrr.io/r/base/Round.html">trunc</a></span>(n<span class="op">/</span><span class="dv">2</span>)<span class="op">+</span><span class="dv">1</span>)]&lt;-<span class="dv">0</span>
   <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n) { 
      lo[i]&lt;-<span class="fl">1.0</span><span class="op">*</span>(i<span class="op">-</span><span class="dv">1</span>)<span class="op">*</span>(n<span class="op">-</span><span class="dv">1</span>)<span class="op">/</span>n
      up[i]&lt;-<span class="fl">1.0</span><span class="op">*</span>i<span class="op">*</span>(n<span class="op">+</span><span class="dv">1</span>)<span class="op">/</span>n
   }
   x&lt;-<span class="fl">0.5</span><span class="op">*</span>(lo<span class="op">+</span>up)
   result&lt;-<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">x=</span>x, <span class="dt">lower=</span>lo, <span class="dt">upper=</span>up, <span class="dt">bdmsk=</span>bmsk)
}

## library(lbfgsb3c)
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(optimx)
<span class="co"># sessionInfo()</span>
oppv&lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/utils/packageDescription.html">packageVersion</a></span>(<span class="st">"optimx"</span>)
<span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"optimx version is "</span>, <span class="kw"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(oppv),<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</code></pre></div>
<pre><code>## optimx version is  2018.7.10</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">if</span> (<span class="kw"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(oppv) <span class="op">&lt;</span><span class="st"> '2019-6.14'</span> ) {
  <span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"Note -- Older version of optimx in use</span><span class="ch">\n</span><span class="st">"</span>)
meths &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"L-BFGS-B"</span>, <span class="st">"Rvmmin"</span>, <span class="st">"Rcgmin"</span>, <span class="st">"Rtnmin"</span>)
nn &lt;-<span class="st"> </span><span class="dv">4</span>
goody &lt;-<span class="st"> </span><span class="kw">bt.setup0</span>(nn)
lo &lt;-<span class="st"> </span>goody<span class="op">$</span>lower
up &lt;-<span class="st"> </span>goody<span class="op">$</span>upper
x0 &lt;-<span class="st"> </span>goody<span class="op">$</span>x
goody
## optim()
## Put trace=3 to get full details
solgood &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/optimx/man/opm.html">opm</a></span>(x0, bt.f, bt.g, <span class="dt">lower=</span>lo, <span class="dt">upper=</span>up, <span class="dt">method=</span>meths, <span class="dt">control=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">trace=</span><span class="dv">0</span>))
<span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(solgood)
<span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(solgood, <span class="dt">order=</span>value))
<span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"Result for lbfgsb3c</span><span class="ch">\n</span><span class="st">"</span>)
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(lbfgsb3c)
sollbcgood &lt;-<span class="st"> </span><span class="kw"><a href="../reference/lbfgsb3c.html">lbfgsb3c</a></span>(x0, bt.f, bt.g, <span class="dt">lower=</span>lo, <span class="dt">upper=</span>up)
sollbcgood
bady &lt;-<span class="st"> </span><span class="kw">bt.badsetup</span>(nn)
lo &lt;-<span class="st"> </span>bady<span class="op">$</span>lower
up &lt;-<span class="st"> </span>bady<span class="op">$</span>upper
x0 &lt;-<span class="st"> </span>bady<span class="op">$</span>x
bady <span class="co"># This has x outside bounds, but method corrects. </span>
## Should we notify user in a more aggressive fashion?
## optim()
## Put trace=3 to get full details
solbad0 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/optimx/man/opm.html">opm</a></span>(x0, bt.f, bt.g, <span class="dt">lower=</span>lo, <span class="dt">upper=</span>up, <span class="dt">method=</span>meths, <span class="dt">control=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">trace=</span><span class="dv">0</span>))
<span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(solbad0, <span class="dt">order=</span>value))
sollbcbad &lt;-<span class="st"> </span><span class="kw"><a href="../reference/lbfgsb3c.html">lbfgsb3c</a></span>(x0, bt.f, bt.g, <span class="dt">lower=</span>lo, <span class="dt">upper=</span>up)
sollbcbad
} <span class="cf">else</span> {
## Following only works with optimx &gt;= 2019-6.14 since lbfgsb3c not present beforehand
meths &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"L-BFGS-B"</span>, <span class="st">"lbfgsb3c"</span>, <span class="st">"lbfgsb3"</span>, <span class="st">"Rvmmin"</span>, <span class="st">"Rcgmin"</span>, <span class="st">"Rtnmin"</span>)
nn &lt;-<span class="st"> </span><span class="dv">4</span>
goody &lt;-<span class="st"> </span><span class="kw">bt.setup0</span>(nn)
lo &lt;-<span class="st"> </span>goody<span class="op">$</span>lower
up &lt;-<span class="st"> </span>goody<span class="op">$</span>upper
x0 &lt;-<span class="st"> </span>goody<span class="op">$</span>x
goody
## optim()
## Put trace=3 to get full details
solgood &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/optimx/man/opm.html">opm</a></span>(x0, bt.f, bt.g, <span class="dt">lower=</span>lo, <span class="dt">upper=</span>up, <span class="dt">method=</span>meths, <span class="dt">control=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">trace=</span><span class="dv">0</span>))
<span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(solgood, <span class="dt">order=</span>value))
bady &lt;-<span class="st"> </span><span class="kw">bt.badsetup</span>(nn)
lo &lt;-<span class="st"> </span>bady<span class="op">$</span>lower
up &lt;-<span class="st"> </span>bady<span class="op">$</span>upper
x0 &lt;-<span class="st"> </span>bady<span class="op">$</span>x
bady <span class="co"># This has x outside bounds, but method corrects. </span>
## Should we notify user in a more aggressive fashion?
## optim()
## Put trace=3 to get full details
solbad0 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/optimx/man/opm.html">opm</a></span>(x0, bt.f, bt.g, <span class="dt">lower=</span>lo, <span class="dt">upper=</span>up, <span class="dt">method=</span>meths, <span class="dt">control=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">trace=</span><span class="dv">0</span>))
<span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(solbad0, <span class="dt">order=</span>value))
}</code></pre></div>
<pre><code>## Note -- Older version of optimx in use
## trace= 0 
##          p1   p2  p3   p4 value fevals gevals convergence  kkt1 kkt2 xtime
## L-BFGS-B  0 0.75 1.5 2.25 7.875      2      2           0 FALSE TRUE 0.004
## Rvmmin    0 0.75 1.5 2.25 7.875      8      8           2 FALSE TRUE 0.002
## Rcgmin    0 0.75 1.5 2.25 7.875      9      8           0 FALSE TRUE 0.001
## Rtnmin    0 0.75 1.5 2.25 7.875      8      8           0 FALSE TRUE 0.002
##          p1   p2  p3   p4 value fevals gevals convergence  kkt1 kkt2 xtime
## L-BFGS-B  0 0.75 1.5 2.25 7.875      2      2           0 FALSE TRUE 0.004
## Rvmmin    0 0.75 1.5 2.25 7.875      8      8           2 FALSE TRUE 0.002
## Rcgmin    0 0.75 1.5 2.25 7.875      9      8           0 FALSE TRUE 0.001
## Rtnmin    0 0.75 1.5 2.25 7.875      8      8           0 FALSE TRUE 0.002
## Result for lbfgsb3c</code></pre>
<pre><code>## Warning in optimr(par, fn, gr, hess = hess, method = meth, lower = lower, : Parameter(s) changed to nearest bounds

## Warning in optimr(par, fn, gr, hess = hess, method = meth, lower = lower, : Parameter(s) changed to nearest bounds</code></pre>
<pre><code>## Warning in Rvmmin(par = spar, fn = efn, gr = egr, lower = slower, upper =
## supper, : Parameter out of bounds has been moved to nearest bound</code></pre>
<pre><code>## trace= 0</code></pre>
<pre><code>## Warning in optimr(par, fn, gr, hess = hess, method = meth, lower = lower, : Parameter(s) changed to nearest bounds</code></pre>
<pre><code>## Warning in Rcgminb(par = spar, fn = efn, gr = egr, lower = slower, upper =
## supper, : x[1], set -1.8 to lower bound = 0</code></pre>
<pre><code>## Warning in Rcgminb(par = spar, fn = efn, gr = egr, lower = slower, upper =
## supper, : x[2], set 0.4 to lower bound = 0.75</code></pre>
<pre><code>## Warning in optimr(par, fn, gr, hess = hess, method = meth, lower = lower, : Parameter(s) changed to nearest bounds</code></pre>
<pre><code>##          p1   p2  p3   p4 value fevals gevals convergence  kkt1 kkt2 xtime
## L-BFGS-B  0 0.75 1.5 2.25 7.875      2      2           0 FALSE TRUE 0.002
## Rvmmin    0 0.75 1.5 2.25 7.875      6      6           2 FALSE TRUE 0.002
## Rcgmin    0 0.75 1.5 2.25 7.875      5      4           0 FALSE TRUE 0.001
## Rtnmin    0 0.75 1.5 2.25 7.875      6      6           0 FALSE TRUE 0.000</code></pre>
<pre><code>## $par
## [1] 0.00 0.75 1.50 2.25
## 
## $grad
## [1] 0.0 1.5 3.0 4.5
## 
## $value
## [1] 7.875
## 
## $counts
## [1] 2 2
## 
## $convergence
## [1] 0
## 
## $message
## [1] "CONVERGENCE: NORM_OF_PROJECTED_GRADIENT_&lt;=_PGTOL"</code></pre>
<div id="candlestick-function" class="section level3">
<h3 class="hasAnchor">
<a href="#candlestick-function" class="anchor"></a>Candlestick function</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># candlestick function</span>
<span class="co"># J C Nash 2011-2-3</span>
cstick.f&lt;-<span class="cf">function</span>(x,<span class="dt">alpha=</span><span class="dv">100</span>){
  x&lt;-<span class="kw"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span>(x)
  r2&lt;-<span class="kw"><a href="https://rdrr.io/r/base/crossprod.html">crossprod</a></span>(x)
  f&lt;-<span class="kw"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>(r2<span class="op">+</span>alpha<span class="op">/</span>r2)
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(f)
}

cstick.g&lt;-<span class="cf">function</span>(x,<span class="dt">alpha=</span><span class="dv">100</span>){
  x&lt;-<span class="kw"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span>(x)
  r2&lt;-<span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/crossprod.html">crossprod</a></span>(x))
  g1&lt;-<span class="dv">2</span><span class="op">*</span>x
  g2 &lt;-<span class="st"> </span>(<span class="op">-</span>alpha)<span class="op">*</span><span class="dv">2</span><span class="op">*</span>x<span class="op">/</span>(r2<span class="op">*</span>r2)
  g&lt;-<span class="kw"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>(g1<span class="op">+</span>g2)
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(g)
}
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(lbfgsb3c)
nn &lt;-<span class="st"> </span><span class="dv">2</span>
x0 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">10</span>,<span class="dv">10</span>)
lo &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">1</span>)
up &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">10</span>,<span class="dv">10</span>)
<span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(x0)</code></pre></div>
<pre><code>## [1] 10 10</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## c2o &lt;- opm(x0, cstick.f, cstick.g, lower=lo, upper=up, method=meths, control=list(trace=0))
## print(summary(c2o, order=value))
c2l1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/lbfgsb3c.html">lbfgsb3c</a></span>(x0, cstick.f, cstick.g, <span class="dt">lower=</span>lo, <span class="dt">upper=</span>up)
c2l1</code></pre></div>
<pre><code>## $par
## [1] 2.2361 2.2361
## 
## $grad
## [1] -2.3517e-09 -2.3517e-09
## 
## $value
## [1] 20
## 
## $counts
## [1] 15 15
## 
## $convergence
## [1] 0
## 
## $message
## [1] "CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">lo &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">4</span>, <span class="dv">4</span>)
## c2ob &lt;- opm(x0, cstick.f, cstick.g, lower=lo, upper=up, method=meths, control=list(trace=0))
## print(summary(c2ob, order=value))
c2l2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/lbfgsb3c.html">lbfgsb3c</a></span>(x0, cstick.f, cstick.g, <span class="dt">lower=</span>lo, <span class="dt">upper=</span>up)
c2l2</code></pre></div>
<pre><code>## $par
## [1] 4 4
## 
## $grad
## [1] 7.2188 7.2188
## 
## $value
## [1] 35.125
## 
## $counts
## [1] 2 2
## 
## $convergence
## [1] 0
## 
## $message
## [1] "CONVERGENCE: NORM_OF_PROJECTED_GRADIENT_&lt;=_PGTOL"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## cstick2b &lt;- opm(x0, cstick.f, cstick.g, method=meths, upper=up, lower=lo, control=list(kkt=FALSE))
## print(summary(cstick2b, par.select=1:2, order=value))

## nn &lt;- 100
## x0 &lt;- rep(10, nn)
## up &lt;- rep(10, nn)
## lo &lt;- rep(1e-4, nn)
## cco &lt;- opm(x0, cstick.f, cstick.g, lower=lo, upper=up, method=meths, control=list(trace=0, kkt=FALSE))
## print(summary(cco, par.select=1:4, order=value))</code></pre></div>
</div>
<div id="extended-rosenbrock-function-from-funconstrain" class="section level3">
<h3 class="hasAnchor">
<a href="#extended-rosenbrock-function-from-funconstrain" class="anchor"></a>Extended Rosenbrock function (from funconstrain)</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># require(funconstrain) ## not in CRAN, so explicit inclusion of this function</span>
<span class="co"># exrosen &lt;- ex_rosen()</span>
<span class="co"># exrosenf &lt;- exrosen$fn</span>
exrosenf &lt;-<span class="st"> </span><span class="cf">function</span> (par) {
    n &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(par)
    <span class="cf">if</span> (n<span class="op">%%</span><span class="dv">2</span> <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) {
        <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span>(<span class="st">"Extended Rosenbrock: n must be even"</span>)
    }
    fsum &lt;-<span class="st"> </span><span class="dv">0</span>
    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>(n<span class="op">/</span><span class="dv">2</span>)) {
        p2 &lt;-<span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>i
        p1 &lt;-<span class="st"> </span>p2 <span class="op">-</span><span class="st"> </span><span class="dv">1</span>
        f_p1 &lt;-<span class="st"> </span><span class="dv">10</span> <span class="op">*</span><span class="st"> </span>(par[p2] <span class="op">-</span><span class="st"> </span>par[p1]<span class="op">^</span><span class="dv">2</span>)
        f_p2 &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>par[p1]
        fsum &lt;-<span class="st"> </span>fsum <span class="op">+</span><span class="st"> </span>f_p1 <span class="op">*</span><span class="st"> </span>f_p1 <span class="op">+</span><span class="st"> </span>f_p2 <span class="op">*</span><span class="st"> </span>f_p2
    }
    fsum
}
<span class="co"># exroseng &lt;- exrosen$gr</span>
exroseng &lt;-<span class="st"> </span><span class="cf">function</span> (par) {
    n &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(par)
    <span class="cf">if</span> (n<span class="op">%%</span><span class="dv">2</span> <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) {
        <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span>(<span class="st">"Extended Rosenbrock: n must be even"</span>)
    }
    grad &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="dv">0</span>, n)
    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>(n<span class="op">/</span><span class="dv">2</span>)) {
        p2 &lt;-<span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>i
        p1 &lt;-<span class="st"> </span>p2 <span class="op">-</span><span class="st"> </span><span class="dv">1</span>
        xx &lt;-<span class="st"> </span>par[p1] <span class="op">*</span><span class="st"> </span>par[p1]
        yx &lt;-<span class="st"> </span>par[p2] <span class="op">-</span><span class="st"> </span>xx
        f_p1 &lt;-<span class="st"> </span><span class="dv">10</span> <span class="op">*</span><span class="st"> </span>yx
        f_p2 &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>par[p1]
        grad[p1] &lt;-<span class="st"> </span>grad[p1] <span class="op">-</span><span class="st"> </span><span class="dv">400</span> <span class="op">*</span><span class="st"> </span>par[p1] <span class="op">*</span><span class="st"> </span>yx <span class="op">-</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>f_p2
        grad[p2] &lt;-<span class="st"> </span>grad[p2] <span class="op">+</span><span class="st"> </span><span class="dv">200</span> <span class="op">*</span><span class="st"> </span>yx
    }
    grad
}

exrosenx0 &lt;-<span class="st"> </span><span class="cf">function</span> (<span class="dt">n =</span> <span class="dv">20</span>) {
    <span class="cf">if</span> (n<span class="op">%%</span><span class="dv">2</span> <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) {
        <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span>(<span class="st">"Extended Rosenbrock: n must be even"</span>)
    }
    <span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">1.2</span>, <span class="dv">1</span>), n<span class="op">/</span><span class="dv">2</span>)
}


<span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span>(lbfgsb3c)
## require(optimx)

## require(optimx)
<span class="cf">for</span> (n <span class="cf">in</span> <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="dv">2</span>,<span class="dv">12</span>, <span class="dt">by=</span><span class="dv">2</span>)) {
  <span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"ex_rosen try for n="</span>,n,<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)
  x0 &lt;-<span class="st"> </span><span class="kw">exrosenx0</span>(n)
  lo &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="op">-</span><span class="fl">1.5</span>, n)
  up &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="dv">3</span>, n)
  <span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(x0)
  <span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"optim L-BFGS-B</span><span class="ch">\n</span><span class="st">"</span>)
  eo &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span>(x0, exrosenf, exroseng, <span class="dt">lower=</span>lo, <span class="dt">upper=</span>up, <span class="dt">method=</span><span class="st">"L-BFGS-B"</span>, <span class="dt">control=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">trace=</span><span class="dv">0</span>))
  <span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(eo)
  <span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"lbfgsb3c</span><span class="ch">\n</span><span class="st">"</span>)
  el &lt;-<span class="st"> </span><span class="kw"><a href="../reference/lbfgsb3c.html">lbfgsb3c</a></span>(x0, exrosenf, exroseng, <span class="dt">lower=</span>lo, <span class="dt">upper=</span>up, <span class="dt">control=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">trace=</span><span class="dv">0</span>))
  <span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(el)
##    erfg &lt;- opm(x0, exrosenf, exroseng, method=meths, lower=lo, upper=up)
##    print(summary(erfg, par.select=1:2, order=value))
}</code></pre></div>
<pre><code>## ex_rosen try for n= 2 
## [1] -1.2  1.0
## optim L-BFGS-B
## $par
## [1] 1 1
## 
## $value
## [1] 3.8444e-14
## 
## $counts
## function gradient 
##       51       51 
## 
## $convergence
## [1] 0
## 
## $message
## [1] "CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH"
## 
## lbfgsb3c
## $par
## [1] 1 1
## 
## $grad
## [1]  2.2417e-07 -3.6522e-08
## 
## $value
## [1] 5.7131e-15
## 
## $counts
## [1] 62 62
## 
## $convergence
## [1] 0
## 
## $message
## [1] "CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH"
## 
## ex_rosen try for n= 4 
## [1] -1.2  1.0 -1.2  1.0
## optim L-BFGS-B
## $par
## [1] 1 1 1 1
## 
## $value
## [1] 7.6888e-14
## 
## $counts
## function gradient 
##       51       51 
## 
## $convergence
## [1] 0
## 
## $message
## [1] "CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH"
## 
## lbfgsb3c
## $par
## [1] 1 1 1 1
## 
## $grad
## [1]  2.2417e-07 -3.6522e-08  2.2417e-07 -3.6522e-08
## 
## $value
## [1] 1.1426e-14
## 
## $counts
## [1] 62 62
## 
## $convergence
## [1] 0
## 
## $message
## [1] "CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH"
## 
## ex_rosen try for n= 6 
## [1] -1.2  1.0 -1.2  1.0 -1.2  1.0
## optim L-BFGS-B
## $par
## [1] 1 1 1 1 1 1
## 
## $value
## [1] 1.1533e-13
## 
## $counts
## function gradient 
##       51       51 
## 
## $convergence
## [1] 0
## 
## $message
## [1] "CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH"
## 
## lbfgsb3c
## $par
## [1] 1 1 1 1 1 1
## 
## $grad
## [1]  2.2417e-07 -3.6522e-08  2.2417e-07 -3.6522e-08  2.2417e-07 -3.6522e-08
## 
## $value
## [1] 1.7139e-14
## 
## $counts
## [1] 62 62
## 
## $convergence
## [1] 0
## 
## $message
## [1] "CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH"
## 
## ex_rosen try for n= 8 
## [1] -1.2  1.0 -1.2  1.0 -1.2  1.0 -1.2  1.0
## optim L-BFGS-B
## $par
## [1] 1 1 1 1 1 1 1 1
## 
## $value
## [1] 1.5378e-13
## 
## $counts
## function gradient 
##       51       51 
## 
## $convergence
## [1] 0
## 
## $message
## [1] "CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH"
## 
## lbfgsb3c
## $par
## [1] 1 1 1 1 1 1 1 1
## 
## $grad
## [1]  2.2417e-07 -3.6522e-08  2.2417e-07 -3.6522e-08  2.2417e-07 -3.6522e-08
## [7]  2.2417e-07 -3.6522e-08
## 
## $value
## [1] 2.2852e-14
## 
## $counts
## [1] 62 62
## 
## $convergence
## [1] 0
## 
## $message
## [1] "CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH"
## 
## ex_rosen try for n= 10 
##  [1] -1.2  1.0 -1.2  1.0 -1.2  1.0 -1.2  1.0 -1.2  1.0
## optim L-BFGS-B
## $par
##  [1] 1 1 1 1 1 1 1 1 1 1
## 
## $value
## [1] 1.9222e-13
## 
## $counts
## function gradient 
##       51       51 
## 
## $convergence
## [1] 0
## 
## $message
## [1] "CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH"
## 
## lbfgsb3c
## $par
##  [1] 1 1 1 1 1 1 1 1 1 1
## 
## $grad
##  [1]  2.2417e-07 -3.6522e-08  2.2417e-07 -3.6522e-08  2.2417e-07
##  [6] -3.6522e-08  2.2417e-07 -3.6522e-08  2.2417e-07 -3.6522e-08
## 
## $value
## [1] 2.8566e-14
## 
## $counts
## [1] 62 62
## 
## $convergence
## [1] 0
## 
## $message
## [1] "CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH"
## 
## ex_rosen try for n= 12 
##  [1] -1.2  1.0 -1.2  1.0 -1.2  1.0 -1.2  1.0 -1.2  1.0 -1.2  1.0
## optim L-BFGS-B
## $par
##  [1] 1 1 1 1 1 1 1 1 1 1 1 1
## 
## $value
## [1] 2.3066e-13
## 
## $counts
## function gradient 
##       51       51 
## 
## $convergence
## [1] 0
## 
## $message
## [1] "CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH"
## 
## lbfgsb3c
## $par
##  [1] 1 1 1 1 1 1 1 1 1 1 1 1
## 
## $grad
##  [1]  2.2417e-07 -3.6521e-08  2.2417e-07 -3.6521e-08  2.2417e-07
##  [6] -3.6521e-08  2.2417e-07 -3.6521e-08  2.2417e-07 -3.6521e-08
## [11]  2.2417e-07 -3.6521e-08
## 
## $value
## [1] 3.4279e-14
## 
## $counts
## [1] 62 62
## 
## $convergence
## [1] 0
## 
## $message
## [1] "CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH"</code></pre>
</div>
</div>
<div id="using-compiled-function-code" class="section level2">
<h2 class="hasAnchor">
<a href="#using-compiled-function-code" class="anchor"></a>Using compiled function code</h2>
<p>While you may use the same interface as described in the writing R extensions to interface compiled code with this function, see <a href="https://cran.r-project.org/doc/manuals/r-release/R-exts.html#Optimization">L-BFGS-B</a>, it is sometimes more convenient to use your own compiled code.</p>
<p>The following example shows how this is done using the file <code>jrosen.f</code>.</p>
<pre><code>       subroutine rosen(n, x, fval)
       double precision x(n), fval, dx
       integer n, i
       fval = 0.0D0
       do 10 i=1,(n-1)
          dx = x(i + 1) - x(i) * x(i)
          fval = fval + 100.0 * dx * dx
          dx = 1.0 - x(i)
          fval = fval + dx * dx
 10    continue
       return
       end</code></pre>
<p>Here is the example script. Note that we must have the file <code>jrosen.f</code> available.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://rdrr.io/r/base/system.html">system</a></span>(<span class="st">"R CMD SHLIB jrosen.f"</span>)
<span class="kw"><a href="https://rdrr.io/r/base/dynload.html">dyn.load</a></span>(<span class="st">"jrosen.so"</span>)
<span class="kw"><a href="https://rdrr.io/r/base/dynload.html">is.loaded</a></span>(<span class="st">"rosen"</span>)</code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x0 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">1.2</span>,<span class="dv">1</span>))
fv &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>(<span class="op">-</span><span class="dv">999</span>)
n &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>(<span class="dv">2</span>)
testf &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Foreign.html">.Fortran</a></span>(<span class="st">"rosen"</span>, <span class="dt">n=</span><span class="kw"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(n), <span class="dt">x=</span><span class="kw"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>(x0), <span class="dt">fval=</span><span class="kw"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>(fv))
testf</code></pre></div>
<pre><code>## $n
## [1] 2
## 
## $x
## [1] -1.2  1.0
## 
## $fval
## [1] 24.2</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rrosen &lt;-<span class="st"> </span><span class="cf">function</span>(x) {
  fval &lt;-<span class="st"> </span><span class="fl">0.0</span>
  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>(n<span class="op">-</span><span class="dv">1</span>)) {
    dx &lt;-<span class="st"> </span>x[i <span class="op">+</span><span class="st"> </span><span class="dv">1</span>] <span class="op">-</span><span class="st"> </span>x[i] <span class="op">*</span><span class="st"> </span>x[i]
    fval &lt;-<span class="st"> </span>fval <span class="op">+</span><span class="st"> </span><span class="fl">100.0</span> <span class="op">*</span><span class="st"> </span>dx <span class="op">*</span><span class="st"> </span>dx
    dx &lt;-<span class="st"> </span><span class="fl">1.0</span> <span class="op">-</span><span class="st"> </span>x[i]
    fval &lt;-<span class="st"> </span>fval <span class="op">+</span><span class="st"> </span>dx <span class="op">*</span><span class="st"> </span>dx
  }
  fval
}

(<span class="kw">rrosen</span>(x0))</code></pre></div>
<pre><code>## [1] 24.2</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">frosen &lt;-<span class="st"> </span><span class="cf">function</span>(x){
  nn &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(x)
  <span class="cf">if</span> (nn <span class="op">&gt;</span><span class="st"> </span><span class="dv">100</span>) { <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span>(<span class="st">"max number of parameters is 100"</span>)}
  fv &lt;-<span class="st"> </span><span class="op">-</span><span class="fl">999.0</span>
  val &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Foreign.html">.Fortran</a></span>(<span class="st">"rosen"</span>, <span class="dt">n=</span><span class="kw"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(nn), <span class="dt">x=</span><span class="kw"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>(x), <span class="dt">fval=</span><span class="kw"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>(fv))
  val<span class="op">$</span>fval <span class="co"># </span><span class="al">NOTE</span><span class="co">--need ONLY function value returned</span>
}
<span class="co"># Test the funcion</span>
tval &lt;-<span class="st"> </span><span class="kw">frosen</span>(x0)
<span class="kw"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(tval)</code></pre></div>
<pre><code>##  num 24.2</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"Run with Nelder-Mead using R function</span><span class="ch">\n</span><span class="st">"</span>)</code></pre></div>
<pre><code>## Run with Nelder-Mead using R function</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mynm &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span>(x0, rrosen, <span class="dt">control=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">trace=</span><span class="dv">0</span>))
<span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(mynm)</code></pre></div>
<pre><code>## $par
## [1] 1.0003 1.0005
## 
## $value
## [1] 8.8252e-08
## 
## $counts
## function gradient 
##      195       NA 
## 
## $convergence
## [1] 0
## 
## $message
## NULL</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"</span><span class="ch">\n\n</span><span class="st"> Run with Nelder-Mead using Fortran function"</span>)</code></pre></div>
<pre><code>## 
## 
##  Run with Nelder-Mead using Fortran function</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mynmf &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span>(x0, frosen, <span class="dt">control=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">trace=</span><span class="dv">0</span>))
<span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(mynmf)</code></pre></div>
<pre><code>## $par
## [1] 1.0003 1.0005
## 
## $value
## [1] 8.8252e-08
## 
## $counts
## function gradient 
##      195       NA 
## 
## $convergence
## [1] 0
## 
## $message
## NULL</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(lbfgsb3c)
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(microbenchmark)
<span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"try lbfgsb3c, no Gradient </span><span class="ch">\n</span><span class="st">"</span>)</code></pre></div>
<pre><code>## try lbfgsb3c, no Gradient</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"R function</span><span class="ch">\n</span><span class="st">"</span>)</code></pre></div>
<pre><code>## R function</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tlR&lt;-<span class="kw"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span>(myopR &lt;-<span class="st"> </span><span class="kw"><a href="../reference/lbfgsb3c.html">lbfgsb3c</a></span>(x0, rrosen, <span class="dt">gr=</span><span class="ot">NULL</span>, <span class="dt">control=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">trace=</span><span class="dv">0</span>)))
<span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(tlR)</code></pre></div>
<pre><code>## Unit: milliseconds
##                                                                 expr
##  myopR &lt;- lbfgsb3c(x0, rrosen, gr = NULL, control = list(trace = 0))
##     min     lq   mean median     uq    max neval
##  12.098 12.745 16.004 14.218 18.968 27.046   100</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(myopR)</code></pre></div>
<pre><code>## $par
## [1] 1.0000 1.0001
## 
## $grad
## [1] -0.00034753  0.00020133
## 
## $value
## [1] 8.6158e-10
## 
## $counts
## [1] 74 74
## 
## $convergence
## [1] 0
## 
## $message
## [1] "CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"Fortran function</span><span class="ch">\n</span><span class="st">"</span>)</code></pre></div>
<pre><code>## Fortran function</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tlF&lt;-<span class="kw"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span>(myop &lt;-<span class="st"> </span><span class="kw"><a href="../reference/lbfgsb3c.html">lbfgsb3c</a></span>(x0, frosen, <span class="dt">gr=</span><span class="ot">NULL</span>, <span class="dt">control=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">trace=</span><span class="dv">0</span>)))
<span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(tlF)</code></pre></div>
<pre><code>## Unit: milliseconds
##                                                                expr    min
##  myop &lt;- lbfgsb3c(x0, frosen, gr = NULL, control = list(trace = 0)) 14.161
##      lq   mean median     uq    max neval
##  14.892 17.295  15.88 19.004 30.703   100</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(myop)</code></pre></div>
<pre><code>## $par
## [1] 1.0000 1.0001
## 
## $grad
## [1] -0.00035076  0.00020302
## 
## $value
## [1] 8.676e-10
## 
## $counts
## [1] 74 74
## 
## $convergence
## [1] 0
## 
## $message
## [1] "CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH"</code></pre>
<p>In this example, Fortran is actually SLOWER than plain R.</p>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-Byrd95">
<p>Byrd, Richard H., Peihuang Lu, Jorge Nocedal, and Ci You Zhu. 1995a. “A Limited Memory Algorithm for Bound Constrained Optimization.” <em>SIAM Journal on Scientific Computing</em> 16 (5): 1190–1208.</p>
</div>
<div id="ref-Byrd1995">
<p>Byrd, Richard H., Peihuang Lu, Jorge Nocedal, and Ciyou Zhu. 1995b. “A Limited Memory Algorithm for Bound Constrained Optimization.” <em>SIAM J. Sci. Comput.</em> 16 (5). Philadelphia, PA, USA: Society for Industrial; Applied Mathematics: 1190–1208. doi:<a href="https://doi.org/10.1137/0916069">10.1137/0916069</a>.</p>
</div>
<div id="ref-Coppola2014">
<p>Coppola, Antonio, Brandon Stewart, and Naoaki Okazaki. 2014. <em>Lbfgs: Limited-Memory Bfgs Optimization</em>. <a href="https://CRAN.R-project.org/package=lbfgs" class="uri">https://CRAN.R-project.org/package=lbfgs</a>.</p>
</div>
<div id="ref-RCppDE2013">
<p>Eddelbuettel, Dirk. 2013. <em>Seamless R and C++ Integration with Rcpp</em>. New York: Springer. doi:<a href="https://doi.org/10.1007/978-1-4614-6868-4">10.1007/978-1-4614-6868-4</a>.</p>
</div>
<div id="ref-RCppDEJJB2017">
<p>Eddelbuettel, Dirk, and James Joseph Balamuta. 2017. “Extending extitR with extitC++: A Brief Introduction to extitRcpp.” <em>PeerJ Preprints</em> 5 (August): e3188v1. doi:<a href="https://doi.org/10.7287/peerj.preprints.3188v1">10.7287/peerj.preprints.3188v1</a>.</p>
</div>
<div id="ref-RCppDERF2011">
<p>Eddelbuettel, Dirk, and Romain François. 2011. “Rcpp: Seamless R and C++ Integration.” <em>Journal of Statistical Software</em> 40 (8): 1–18. doi:<a href="https://doi.org/10.18637/jss.v040.i08">10.18637/jss.v040.i08</a>.</p>
</div>
<div id="ref-lbfgsb3cMF">
<p>Fidler, Matthew L, John C Nash, Ciyou Zhu, Richard Byrd, Jorge Nocedal, and Jose Luis Morales. 2018. <em>lbfgsb3c: Limited Memory Bfgs Minimizer with Bounds on Parameters with Optim() ’c’ Interface</em>. <a href="https://CRAN.R-project.org/package=lbfgsb3c" class="uri">https://CRAN.R-project.org/package=lbfgsb3c</a>.</p>
</div>
<div id="ref-LiuN89">
<p>Liu, Dong C., and Jorge Nocedal. 1989. “On the Limited Memory BFGS Method for Large Scale Optimization.” <em>Math. Program.</em> 45 (1-3): 503–28. doi:<a href="https://doi.org/10.1007/BF01589116">10.1007/BF01589116</a>.</p>
</div>
<div id="ref-Lu94limitedmemory">
<p>Lu, Peihuang, Jorge Nocedal, Ciyou Zhu, and Richard H. Byrd. 1994. “A Limited-Memory Algorithm for Bound Constrained Optimization.” <em>SIAM Journal on Scientific Computing</em> 16: 1190–1208.</p>
</div>
<div id="ref-Morales2011">
<p>Morales, José Luis, and Jorge Nocedal. 2011. “Remark on Algorithm 778: L-BFGS-B: Fortran subroutines for large-scale bound constrained optimization.” <em>ACM Trans. Math. Softw.</em> 38 (1). New York, NY, USA: ACM: 7:1–7:4. <a href="http://doi.acm.org/10.1145/2049662.2049669" class="uri">http://doi.acm.org/10.1145/2049662.2049669</a>.</p>
</div>
<div id="ref-lbfgsb3JN">
<p>Nash, John C, Ciyou Zhu, Richard Byrd, Jorge Nocedal, and Jose Luis Morales. 2015. <em>lbfgsb3: Limited Memory Bfgs Minimizer with Bounds on Parameters</em>. <a href="https://CRAN.R-project.org/package=lbfgsb3" class="uri">https://CRAN.R-project.org/package=lbfgsb3</a>.</p>
</div>
<div id="ref-Zhu1997LBFGS">
<p>Zhu, Ciyou, Richard H. Byrd, Peihuang Lu, and Jorge Nocedal. 1997. “Algorithm 778: L-BFGS-B: Fortran Subroutines for Large-Scale Bound-Constrained Optimization.” <em>ACM Trans. Math. Softw.</em> 23 (4). New York, NY, USA: ACM: 550–60. doi:<a href="https://doi.org/10.1145/279232.279236">10.1145/279232.279236</a>.</p>
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#abstract">Abstract</a><ul class="nav nav-pills nav-stacked">
<li><a href="#provenance-of-the-r-optiml-bfgs-b-and-related-solvers">Provenance of the R optim::L-BFGS-B and related solvers</a></li>
      <li><a href="#functions-in-package-lbfgsb3c">Functions in package <code>lbfgsb3c</code></a></li>
      <li><a href="#comparison-with-optiml-bfgs-b">Comparison with optim::L-BFGS-B</a></li>
      <li><a href="#using-compiled-function-code">Using compiled function code</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Matthew L Fidler, John C Nash, Ciyou Zhu, Richard Byrd, Jorge Nocedal, Jose Luis Morales.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
